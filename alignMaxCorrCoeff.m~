function [nD1 nD2 maxc lag] = alignMaxCorrCoeff(D1,D2)

% [nD1 nD2 maxc lag] = alignMaxCorrCoeff(D1,D2);
% 
% Align two signals on their maximum correlation coefficient (maxC).
%
% Inputs:   D1, D2, the two signals to align
% Outputs:  nD1, nD2, the aligned signals
%           maxc is maximum correlation coefficient
%           lag is lag between two events.
%
% NOTE: THIS DOES NOT CORRECT FOR NEGATIVE POLARITY

[c lags] = xcorr(D1,D2);

% Lag at maximum correlation coefficient
lagmax = lags(abs(c) == max(abs(c)));


maxlength = max([length(D1) length(D2)]);
nD1 = zeros(maxlength+abs(lagmax));
nD2 = zeros(maxlength+abs(lagmax));


if lagmax < 0
    nD1 = D1(1:end+lagmax);
elseif lagmax > 0
    eval(['Stack(i,newlag(l)+1:end) = Stack(i,newlag(l)+1:end) + sgn(l,i)*maxcoeff(l,i)*' varD '(i,1:end-newlag(l));'])
        
 end  
        
 